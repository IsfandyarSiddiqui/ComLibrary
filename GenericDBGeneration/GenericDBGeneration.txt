

// *** SOURCE FILE: AppDataConnection.cs ***
using GenericDBGeneration.Tables;
using LinqToDB;
using LinqToDB.Data;
using LinqToDB.DataProvider.SqlServer;

namespace GenericDBGeneration;
public class AppDataConnection : DataConnection
{   
    public AppDataConnection(): 
        base(SqlServerTools.GetDataProvider(SqlServerVersion.v2022), Resources.ConnectionString)
    {
    }

    // This property exposes the User entity as an operable table (ITable<T>) 
    // within the context, allowing you to run LINQ queries against it.
    public ITable<Users> Users => this.GetTable<Users>();
    public ITable<UserLogs> UserLogs => this.GetTable<UserLogs>();
}


// *** SOURCE FILE: Program.cs ***
using GenericDBGeneration;
using GenericDBGeneration.Tables;
using GenericDBGeneration.Tables.Common;
using GenericDBGeneration.Triggers;
using LinqToDB;
using LinqToDB.Data;

var myUsersTable = new Users() {
    fullName = "isfanyar siddiqui",
    preferedName = "isfanyar",
    password = "password",
};
var myUserLogsTable = new UserLogs(myUsersTable, SQLActionType.Insert) { changes = ""};

TriggerType[] tts = [TriggerType.Insert, TriggerType.Delete, TriggerType.Update];
foreach(var tt in tts)
{
    var temp = LogginTriggers.Create
    (
        nameof(AppDataConnection.Users),
        nameof(AppDataConnection.UserLogs),
        nameof(AppDataConnection.Users),
        tt
    );
    Console.WriteLine(temp);
    Console.WriteLine();
}


//await GenerateSomeSqlAsync();
async Task GenerateSomeSqlAsync()
{
    using var db = new AppDataConnection();
    var options = new BulkCopyOptions
    {
        KeepIdentity = false,
        CheckConstraints = true,
        FireTriggers = true,
        NotifyAfter = 50
    };

    db.DropTable<Users>();
    db.DropTable<UserLogs>();
    db.CreateTable<Users>();
    db.CreateTable<UserLogs>();

    db.BulkCopy(options, Users.CreateFakeUsers(20));


    //var users = db.Query<User>("select * from Users").ToList();
    var users = await db.Users.ToArrayAsync();

    foreach (var u in users)
        Console.WriteLine($"{u.userId} || {u.preferedName} || {u.password} || {u.email} || {u.lastActionDate}");

    Console.WriteLine();
    Console.WriteLine("The Users table has been successfully dropped and recreated in SQL Server.");
}




// *** SOURCE FILE: Resources.Designer.cs ***
//------------------------------------------------------------------------------
// <auto-generated>
//     This code was generated by a tool.
//     Runtime Version:4.0.30319.42000
//
//     Changes to this file may cause incorrect behavior and will be lost if
//     the code is regenerated.
// </auto-generated>
//------------------------------------------------------------------------------

namespace GenericDBGeneration {
    using System;
    
    
    /// <summary>
    ///   A strongly-typed resource class, for looking up localized strings, etc.
    /// </summary>
    // This class was auto-generated by the StronglyTypedResourceBuilder
    // class via a tool like ResGen or Visual Studio.
    // To add or remove a member, edit your .ResX file then rerun ResGen
    // with the /str option, or rebuild your VS project.
    [global::System.CodeDom.Compiler.GeneratedCodeAttribute("System.Resources.Tools.StronglyTypedResourceBuilder", "18.0.0.0")]
    [global::System.Diagnostics.DebuggerNonUserCodeAttribute()]
    [global::System.Runtime.CompilerServices.CompilerGeneratedAttribute()]
    internal class Resources {
        
        private static global::System.Resources.ResourceManager resourceMan;
        
        private static global::System.Globalization.CultureInfo resourceCulture;
        
        [global::System.Diagnostics.CodeAnalysis.SuppressMessageAttribute("Microsoft.Performance", "CA1811:AvoidUncalledPrivateCode")]
        internal Resources() {
        }
        
        /// <summary>
        ///   Returns the cached ResourceManager instance used by this class.
        /// </summary>
        [global::System.ComponentModel.EditorBrowsableAttribute(global::System.ComponentModel.EditorBrowsableState.Advanced)]
        internal static global::System.Resources.ResourceManager ResourceManager {
            get {
                if (object.ReferenceEquals(resourceMan, null)) {
                    global::System.Resources.ResourceManager temp = new global::System.Resources.ResourceManager("GenericDBGeneration.Resources", typeof(Resources).Assembly);
                    resourceMan = temp;
                }
                return resourceMan;
            }
        }
        
        /// <summary>
        ///   Overrides the current thread's CurrentUICulture property for all
        ///   resource lookups using this strongly typed resource class.
        /// </summary>
        [global::System.ComponentModel.EditorBrowsableAttribute(global::System.ComponentModel.EditorBrowsableState.Advanced)]
        internal static global::System.Globalization.CultureInfo Culture {
            get {
                return resourceCulture;
            }
            set {
                resourceCulture = value;
            }
        }
        
        /// <summary>
        ///   Looks up a localized string similar to &quot;ConnectionStrings&quot;: { &quot;release01&quot;: &quot;Data Source = release01; Initial Catalog=LiveIssues_CureMD; pooling=true; User = curemd; Password=cure2000; Max Pool Size=4000; Encrypt=True; TrustServerCertificate=True;&quot;,&quot;local&quot;: &quot;Server=(localdb)\\localRelease;Integrated Security=true;&quot;}.
        /// </summary>
        internal static string ConnectionString {
            get {
                return ResourceManager.GetString("ConnectionString", resourceCulture);
            }
        }
    }
}



// *** SOURCE FILE: Crypto.cs ***
using System.Security.Cryptography;
using System.Text;

namespace GenericDBGeneration.Utils;

public static class Crypto
{
    public static string sha256(string str)
    {
        using var sha256Generator = SHA256.Create();
        var bytes = Encoding.UTF8.GetBytes(str);
        var hash = sha256Generator.ComputeHash(bytes);
        return Convert.ToHexString(hash);
    }
}



// *** SOURCE FILE: Users.cs ***
using GenericDBGeneration.Tables.Common;
using LinqToDB.Mapping;
using Bogus;
using GenericDBGeneration.Utils;

namespace GenericDBGeneration.Tables;

[Table("Users")] public class Users: LogableBase
{
    [PrimaryKey, Identity] public int userId { get; set; }
    [Str64] public required string fullName { get; set; }
    [Str32] public required string preferedName { get; set; }
    [Str64] public required string password { get; set => field = Crypto.sha256(value); }
    [Str64] public string? email { get; set; }

    private const string gmail = "gmail.com";
    private const string outlook = "outlook.com";
    private static readonly string[] dummyPasswords = ["aa", "aaa", "aaaa"];
    
    public static List<Users> CreateFakeUsers(int count) =>
        new Faker<Users>()
        .Rules((f, u) =>
        {
            u.fullName = f.Name.FullName();
            u.preferedName = u.fullName.Split(' ').First();

            u.password = f.Random.ArrayElement(dummyPasswords);

            u.email = $"{u.fullName}_{f.Random.Int(10, 99)}@".ToLowerInvariant().Replace(' ', '_');
            if(f.Random.Bool()) u.email += gmail;
            else u.email += outlook;

            u.lastActionByUserId = 0;
        }).Generate(count);
}

[Table("UsersLogs")]
public class UserLogs : LogTableBase
{
    public UserLogs(Users u, SQLActionType actionType) : base(u, actionType) {}

    [Association(ThisKey = nameof(originalId), OtherKey = nameof(Users.userId), CanBeNull = false)]
    public override int originalId { get; set; }
}



// *** SOURCE FILE: ITableTag.cs ***
namespace GenericDBGeneration.Tables.Common;

public interface ITableTag {}



// *** SOURCE FILE: LogableBase.cs ***
using LinqToDB.Mapping;
using System.Runtime.CompilerServices;

namespace GenericDBGeneration.Tables.Common;

public abstract class LogableBase: ITableTag
{
    [Column(DbType = "DateTime2 DEFAULT GETUTCDATE()", CanBeNull = false, SkipOnInsert = true, SkipOnUpdate = true)] 
    public DateTime lastActionDate { get; set; }
    
    [NotNull] 
    public int lastActionByUserId { get; set; }
}

public class ConcreteLogableBase : LogableBase { }
public class ConcreteLogTableBase : LogTableBase
{
    public ConcreteLogTableBase(ConcreteLogableBase logableBase, SQLActionType sqlActionType) 
        : base(logableBase, sqlActionType) { }
    public override int originalId { get; set; } = -1;

}

public abstract class LogTableBase: LogableBase
{
    protected LogTableBase(LogableBase logableBase, SQLActionType sqlActionType)
    {
        lastActionByUserId = logableBase.lastActionByUserId;
        lastActionDate = logableBase.lastActionDate;
        logId = -1;
        changes = string.Empty;
        actionType = sqlActionType;
        originalId = -1;
    }

    [PrimaryKey, Identity] public int logId { get; set; } // Log tables need their own PK
    [Column(DbType = "NVARCHAR(MAX)"), NotNull] public required string changes { get; set; }
    public SQLActionType actionType { get; set; }
    public abstract int originalId { get; set; } 
}

public enum SQLActionType
{
    Insert = 1,
    Update = 2,
    Delete = 3
}



// *** SOURCE FILE: StringAttributes.cs ***
using LinqToDB;
using LinqToDB.Mapping;

namespace GenericDBGeneration.Tables.Common;
public class StrAttribute : ColumnAttribute
{
    public StrAttribute(int length, bool canBeNull)
    {
        DataType = DataType.NVarChar;
        Length = length;
        CanBeNull = canBeNull;
    }
}

public class Str32Attribute(bool nullable = false) : StrAttribute(32, nullable) { }

public class Str64Attribute(bool nullable = false) : StrAttribute(64, nullable) { }

public class Str255Attribute(bool nullable = false) : StrAttribute(255, nullable) { }


// *** SOURCE FILE: LogginTriggers.cs ***
namespace GenericDBGeneration.Triggers;

public static class LogginTriggers
{
    public static string Create(string baseTable, string logTable, string primaryKey, TriggerType tt) =>
        $"""
        GO
        CREATE OR ALTER TRIGGER [dbo].[trg_{baseTable}_{tt}]
        ON [dbo].[{baseTable}]
        AFTER {tt}
        AS
        BEGIN
            SET NOCOUNT ON;

            INSERT INTO [dbo].[{logTable}] (
                [originalId], 
                [actionType], 
                [lastActionDate], 
                [lastActionByUserId], 
                [changes]
            )Tr
            SELECT 
                iud.[{primaryKey}], 
                {(int)tt},
                iud.lastActionDate, 
                iud.lastActionByUserId,
                (
                    SELECT * FROM {ToTriggerTable(tt)} sub 
                    WHERE sub.[{primaryKey}] = iud.[{primaryKey}] 
                    FOR JSON PATH, WITHOUT_ARRAY_WRAPPER
                )
            FROM inserted iud;
        END;
        GO
        """;

    public static string ToTriggerTable(TriggerType tt) => tt switch
    {
        TriggerType.Insert => "Inserted",
        TriggerType.Update => "Inserted",
        TriggerType.Delete => "Deleted",
        _ => throw new NotImplementedException(),
    };
}

public enum TriggerType { Insert, Update, Delete }

